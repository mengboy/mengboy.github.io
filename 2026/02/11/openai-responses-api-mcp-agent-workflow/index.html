<!DOCTYPE html>
<html lang="zh-cn" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>OpenAI Responses API &#43; MCP 实战：从函数调用到 Agent 工作流 | Mengboy 技术笔记</title>
<meta name="keywords" content="OpenAI Responses API, MCP, Agent, 函数调用, AI 工作流">
<meta name="description" content="如果你已经做过函数调用（function calling），但一上复杂流程就开始写一堆胶水代码，那你差不多到了该用 Responses API &#43; MCP 的阶段。
这篇不讲空概念，直接给你一个可落地的路线：把“模型调用工具”升级成“可扩展 Agent 工作流”，让检索、执行、校验、回写变成标准流程。">
<meta name="author" content="mengboy">
<link rel="canonical" href="https://www.mfun.ink/2026/02/11/openai-responses-api-mcp-agent-workflow/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.b407885730516c77be0e6285ab84c0e6c304358f0d1d813f99cea6add2695ff3.css" integrity="sha256-tAeIVzBRbHe&#43;DmKFq4TA5sMENY8NHYE/mc6mrdJpX/M=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://www.mfun.ink/images/site/favicon.png">
<link rel="icon" type="image/png" sizes="16x16" href="https://www.mfun.ink/images/site/favicon.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://www.mfun.ink/images/site/favicon.png">
<link rel="apple-touch-icon" href="https://www.mfun.ink/images/site/favicon.png">
<link rel="mask-icon" href="https://www.mfun.ink/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh-cn" href="https://www.mfun.ink/2026/02/11/openai-responses-api-mcp-agent-workflow/">
<link rel="alternate" hreflang="en" href="https://www.mfun.ink/en/2026/02/11/openai-responses-api-mcp-agent-workflow/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2789089615690497" crossorigin="anonymous"></script>


<script>
     window.adsbygoogle = window.adsbygoogle || [];
     
</script>





<script async src="https://www.googletagmanager.com/gtag/js?id=G-PPJ7YW67PL"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-PPJ7YW67PL');
</script>


      <script async src="https://www.googletagmanager.com/gtag/js?id=G-PPJ7YW67PL"></script>
      <script>
        var doNotTrack = false;
        if ( true ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-PPJ7YW67PL');
        }
      </script><meta property="og:url" content="https://www.mfun.ink/2026/02/11/openai-responses-api-mcp-agent-workflow/">
  <meta property="og:site_name" content="Mengboy 技术笔记">
  <meta property="og:title" content="OpenAI Responses API &#43; MCP 实战：从函数调用到 Agent 工作流">
  <meta property="og:description" content="如果你已经做过函数调用（function calling），但一上复杂流程就开始写一堆胶水代码，那你差不多到了该用 Responses API &#43; MCP 的阶段。
这篇不讲空概念，直接给你一个可落地的路线：把“模型调用工具”升级成“可扩展 Agent 工作流”，让检索、执行、校验、回写变成标准流程。">
  <meta property="og:locale" content="zh-cn">
  <meta property="og:type" content="article">
    <meta property="article:section" content="post">
    <meta property="article:published_time" content="2026-02-11T23:15:00+08:00">
    <meta property="article:modified_time" content="2026-02-11T23:15:00+08:00">
    <meta property="article:tag" content="OpenAI Responses API">
    <meta property="article:tag" content="MCP">
    <meta property="article:tag" content="Agent">
    <meta property="article:tag" content="函数调用">
    <meta property="article:tag" content="AI 工作流">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="OpenAI Responses API &#43; MCP 实战：从函数调用到 Agent 工作流">
<meta name="twitter:description" content="如果你已经做过函数调用（function calling），但一上复杂流程就开始写一堆胶水代码，那你差不多到了该用 Responses API &#43; MCP 的阶段。
这篇不讲空概念，直接给你一个可落地的路线：把“模型调用工具”升级成“可扩展 Agent 工作流”，让检索、执行、校验、回写变成标准流程。">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://www.mfun.ink/post/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "OpenAI Responses API + MCP 实战：从函数调用到 Agent 工作流",
      "item": "https://www.mfun.ink/2026/02/11/openai-responses-api-mcp-agent-workflow/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "OpenAI Responses API + MCP 实战：从函数调用到 Agent 工作流",
  "name": "OpenAI Responses API \u002b MCP 实战：从函数调用到 Agent 工作流",
  "description": "如果你已经做过函数调用（function calling），但一上复杂流程就开始写一堆胶水代码，那你差不多到了该用 Responses API + MCP 的阶段。\n这篇不讲空概念，直接给你一个可落地的路线：把“模型调用工具”升级成“可扩展 Agent 工作流”，让检索、执行、校验、回写变成标准流程。\n",
  "keywords": [
    "OpenAI Responses API", "MCP", "Agent", "函数调用", "AI 工作流"
  ],
  "articleBody": "如果你已经做过函数调用（function calling），但一上复杂流程就开始写一堆胶水代码，那你差不多到了该用 Responses API + MCP 的阶段。\n这篇不讲空概念，直接给你一个可落地的路线：把“模型调用工具”升级成“可扩展 Agent 工作流”，让检索、执行、校验、回写变成标准流程。\n一句话结论 Function Calling 适合单次工具调用。 Responses API + MCP 适合多工具、多步骤、有状态的任务编排。 你真正需要的不是更强的 prompt，而是更稳定的“工具层协议 + 工作流结构”。 一、先把边界说清楚：Function Calling vs MCP Function Calling 的典型问题 你会很快遇到这几个坑：\n工具注册分散在业务代码里，项目一大就难维护。 跨工具协作（比如先查文档再改配置再回写）要自己手搓状态机。 工具权限和可观测性不统一，排障靠猜。 MCP 解决的核心点 MCP（Model Context Protocol）不是“又一个 SDK”，它本质上是工具层标准化：\n工具发现：模型知道有什么工具可用 工具调用：统一输入输出结构 工具隔离：权限边界更清晰 可观测性：每一步调用可追踪 二、最小可用架构（MVP） 建议你从这个三层结构起步：\nOrchestrator：你的业务入口（比如一个任务执行器） Model Layer：Responses API 负责推理与决策 Tool Layer：通过 MCP 暴露检索、读写、执行类工具 流程示意：\n用户任务进入 Orchestrator 模型先拆解任务，再选择工具 MCP 工具返回结构化结果 模型基于结果继续下一步或给结论 三、一个可复制的调用骨架 下面是简化版伪代码（重点看结构，不纠结 SDK 细节）：\nfrom openai import OpenAI client = OpenAI() tools = [ { \"type\": \"mcp\", \"server_label\": \"docs\", \"server_url\": \"http://127.0.0.1:8080/mcp\" }, { \"type\": \"mcp\", \"server_label\": \"ops\", \"server_url\": \"http://127.0.0.1:8081/mcp\" } ] resp = client.responses.create( model=\"gpt-5\", input=\"定位昨晚部署失败原因，并给出修复步骤\", tools=tools ) print(resp.output_text) 一个更稳的做法是把“执行前确认”做成硬规则：\nPOLICY = { \"dangerous_actions_require_approval\": True, \"readonly_tools_default\": True, \"max_tool_hops\": 8 } 四、排障与质量控制（这部分最容易被忽略） 1) 让工具输出结构化 JSON 不要返回一坨自然语言，至少保证：\n{ \"status\": \"ok\", \"data\": {}, \"error\": null, \"trace_id\": \"...\" } 这样模型才能稳定地进行下一步决策，而不是“猜你的返回格式”。\n2) 给每个工具加超时和重试 # 伪配置示例 TOOL_TIMEOUT_MS=8000 TOOL_MAX_RETRY=2 TOOL_RETRY_BACKOFF_MS=300 3) 记录可回放日志 至少记录：\n输入任务 模型中间决策摘要 每次 MCP 调用入参与出参 最终输出 没有回放日志，线上问题基本等于玄学。\n五、常见误区 误区 1：把 MCP 当“万能插件系统” MCP 是协议层，不会替你做业务建模。工具设计烂，协议再标准也救不回来。\n误区 2：工具越多越强 错。工具太多会拉低决策稳定性。先做 3-5 个高价值工具，跑顺再扩。\n误区 3：只看首轮效果，不看长任务稳定性 你应该盯的是：\n多步任务完成率 工具调用失败率 平均调用 hops 人工接管率 六、最小落地清单（可直接照着做） 先选一个单场景（例如“发布故障定位”）。 只接 3 个 MCP 工具：日志检索、配置读取、执行建议。 Responses API 做任务拆解和工具路由。 加审批闸门（高风险动作必须人确认）。 跑 1 周日志，按失败路径迭代。 这套做完，你的 Agent 才算从“能演示”升级到“能上线”。\n总结 Responses API 负责“脑子”，MCP 负责“手脚”，工作流负责“规矩”。\n三者拆开你会很痛苦，组合起来才是生产可用的 Agent 架构。\n如果你正在从 function calling 迁移，建议按“单场景 MVP → 指标化 → 扩工具”这条路径走，别一上来就全家桶。\n",
  "wordCount" : "1240",
  "inLanguage": "zh-cn",
  "datePublished": "2026-02-11T23:15:00+08:00",
  "dateModified": "2026-02-11T23:15:00+08:00",
  "author":{
    "@type": "Person",
    "name": "mengboy"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://www.mfun.ink/2026/02/11/openai-responses-api-mcp-agent-workflow/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Mengboy 技术笔记",
    "logo": {
      "@type": "ImageObject",
      "url": "https://www.mfun.ink/images/site/favicon.png"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://www.mfun.ink/" accesskey="h" title="Mengboy 技术笔记 (Alt + H)">Mengboy 技术笔记</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
                <ul class="lang-switch"><li>|</li>
                    <li>
                        <a href="https://www.mfun.ink/en/" title="English"
                            aria-label="English">En</a>
                    </li>
                </ul>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://www.mfun.ink/" title="首页">
                    <span>首页</span>
                </a>
            </li>
            <li>
                <a href="https://www.mfun.ink/categories/" title="分类">
                    <span>分类</span>
                </a>
            </li>
            <li>
                <a href="https://www.mfun.ink/tags/" title="标签">
                    <span>标签</span>
                </a>
            </li>
            <li>
                <a href="https://www.mfun.ink/archives/" title="归档">
                    <span>归档</span>
                </a>
            </li>
            <li>
                <a href="https://www.mfun.ink/search/" title="搜索 (Alt &#43; /)" accesskey=/>
                    <span>搜索</span>
                </a>
            </li>
            <li>
                <a href="https://www.mfun.ink/about/" title="关于我">
                    <span>关于我</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://www.mfun.ink/">Home</a>&nbsp;»&nbsp;<a href="https://www.mfun.ink/post/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      OpenAI Responses API &#43; MCP 实战：从函数调用到 Agent 工作流
    </h1>
    <div class="post-meta"><span title='2026-02-11 23:15:00 +0800 CST'>February 11, 2026</span>&nbsp;·&nbsp;3 min&nbsp;·&nbsp;mengboy&nbsp;|&nbsp;Translations:
<ul class="i18n_list">
    <li>
        <a href="https://www.mfun.ink/en/2026/02/11/openai-responses-api-mcp-agent-workflow/">En</a>
    </li>
</ul>

</div>
  </header> 
  <div class="ad-in-article ad-top" style="margin: 20px 0; text-align:center;">
  <ins class="adsbygoogle"
      style="display:block"
      data-ad-client="ca-pub-2789089615690497"
      data-ad-slot="6136665648"
      data-ad-format="auto"
      data-full-width-responsive="true"></ins>
  <script>
      (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>
  <div class="post-content"><p>如果你已经做过函数调用（function calling），但一上复杂流程就开始写一堆胶水代码，那你差不多到了该用 <strong>Responses API + MCP</strong> 的阶段。</p>
<p>这篇不讲空概念，直接给你一个可落地的路线：把“模型调用工具”升级成“可扩展 Agent 工作流”，让检索、执行、校验、回写变成标准流程。</p>
<h3 id="一句话结论">一句话结论<a hidden class="anchor" aria-hidden="true" href="#一句话结论">#</a></h3>
<ul>
<li><strong>Function Calling</strong> 适合单次工具调用。</li>
<li><strong>Responses API + MCP</strong> 适合多工具、多步骤、有状态的任务编排。</li>
<li>你真正需要的不是更强的 prompt，而是更稳定的“工具层协议 + 工作流结构”。</li>
</ul>
<h3 id="一先把边界说清楚function-calling-vs-mcp">一、先把边界说清楚：Function Calling vs MCP<a hidden class="anchor" aria-hidden="true" href="#一先把边界说清楚function-calling-vs-mcp">#</a></h3>
<h4 id="function-calling-的典型问题">Function Calling 的典型问题<a hidden class="anchor" aria-hidden="true" href="#function-calling-的典型问题">#</a></h4>
<p>你会很快遇到这几个坑：</p>
<ol>
<li>工具注册分散在业务代码里，项目一大就难维护。</li>
<li>跨工具协作（比如先查文档再改配置再回写）要自己手搓状态机。</li>
<li>工具权限和可观测性不统一，排障靠猜。</li>
</ol>
<h4 id="mcp-解决的核心点">MCP 解决的核心点<a hidden class="anchor" aria-hidden="true" href="#mcp-解决的核心点">#</a></h4>
<p>MCP（Model Context Protocol）不是“又一个 SDK”，它本质上是工具层标准化：</p>
<ul>
<li>工具发现：模型知道有什么工具可用</li>
<li>工具调用：统一输入输出结构</li>
<li>工具隔离：权限边界更清晰</li>
<li>可观测性：每一步调用可追踪</li>
</ul>
<h3 id="二最小可用架构mvp">二、最小可用架构（MVP）<a hidden class="anchor" aria-hidden="true" href="#二最小可用架构mvp">#</a></h3>
<p>建议你从这个三层结构起步：</p>
<ol>
<li><strong>Orchestrator</strong>：你的业务入口（比如一个任务执行器）</li>
<li><strong>Model Layer</strong>：Responses API 负责推理与决策</li>
<li><strong>Tool Layer</strong>：通过 MCP 暴露检索、读写、执行类工具</li>
</ol>
<p>流程示意：</p>
<ul>
<li>用户任务进入 Orchestrator</li>
<li>模型先拆解任务，再选择工具</li>
<li>MCP 工具返回结构化结果</li>
<li>模型基于结果继续下一步或给结论</li>
</ul>
<h3 id="三一个可复制的调用骨架">三、一个可复制的调用骨架<a hidden class="anchor" aria-hidden="true" href="#三一个可复制的调用骨架">#</a></h3>
<p>下面是简化版伪代码（重点看结构，不纠结 SDK 细节）：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> openai <span style="color:#f92672">import</span> OpenAI
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>client <span style="color:#f92672">=</span> OpenAI()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tools <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;mcp&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;server_label&#34;</span>: <span style="color:#e6db74">&#34;docs&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;server_url&#34;</span>: <span style="color:#e6db74">&#34;http://127.0.0.1:8080/mcp&#34;</span>
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;mcp&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;server_label&#34;</span>: <span style="color:#e6db74">&#34;ops&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;server_url&#34;</span>: <span style="color:#e6db74">&#34;http://127.0.0.1:8081/mcp&#34;</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>resp <span style="color:#f92672">=</span> client<span style="color:#f92672">.</span>responses<span style="color:#f92672">.</span>create(
</span></span><span style="display:flex;"><span>  model<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;gpt-5&#34;</span>,
</span></span><span style="display:flex;"><span>  input<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;定位昨晚部署失败原因，并给出修复步骤&#34;</span>,
</span></span><span style="display:flex;"><span>  tools<span style="color:#f92672">=</span>tools
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(resp<span style="color:#f92672">.</span>output_text)
</span></span></code></pre></div><p>一个更稳的做法是把“执行前确认”做成硬规则：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>POLICY <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;dangerous_actions_require_approval&#34;</span>: <span style="color:#66d9ef">True</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;readonly_tools_default&#34;</span>: <span style="color:#66d9ef">True</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;max_tool_hops&#34;</span>: <span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="四排障与质量控制这部分最容易被忽略">四、排障与质量控制（这部分最容易被忽略）<a hidden class="anchor" aria-hidden="true" href="#四排障与质量控制这部分最容易被忽略">#</a></h3>
<h4 id="1-让工具输出结构化-json">1) 让工具输出结构化 JSON<a hidden class="anchor" aria-hidden="true" href="#1-让工具输出结构化-json">#</a></h4>
<p>不要返回一坨自然语言，至少保证：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;status&#34;</span>: <span style="color:#e6db74">&#34;ok&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;data&#34;</span>: {},
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;error&#34;</span>: <span style="color:#66d9ef">null</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;trace_id&#34;</span>: <span style="color:#e6db74">&#34;...&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>这样模型才能稳定地进行下一步决策，而不是“猜你的返回格式”。</p>
<h4 id="2-给每个工具加超时和重试">2) 给每个工具加超时和重试<a hidden class="anchor" aria-hidden="true" href="#2-给每个工具加超时和重试">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 伪配置示例</span>
</span></span><span style="display:flex;"><span>TOOL_TIMEOUT_MS<span style="color:#f92672">=</span><span style="color:#ae81ff">8000</span>
</span></span><span style="display:flex;"><span>TOOL_MAX_RETRY<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>TOOL_RETRY_BACKOFF_MS<span style="color:#f92672">=</span><span style="color:#ae81ff">300</span>
</span></span></code></pre></div><h4 id="3-记录可回放日志">3) 记录可回放日志<a hidden class="anchor" aria-hidden="true" href="#3-记录可回放日志">#</a></h4>
<p>至少记录：</p>
<ul>
<li>输入任务</li>
<li>模型中间决策摘要</li>
<li>每次 MCP 调用入参与出参</li>
<li>最终输出</li>
</ul>
<p>没有回放日志，线上问题基本等于玄学。</p>
<h3 id="五常见误区">五、常见误区<a hidden class="anchor" aria-hidden="true" href="#五常见误区">#</a></h3>
<h4 id="误区-1把-mcp-当万能插件系统">误区 1：把 MCP 当“万能插件系统”<a hidden class="anchor" aria-hidden="true" href="#误区-1把-mcp-当万能插件系统">#</a></h4>
<p>MCP 是协议层，不会替你做业务建模。工具设计烂，协议再标准也救不回来。</p>
<h4 id="误区-2工具越多越强">误区 2：工具越多越强<a hidden class="anchor" aria-hidden="true" href="#误区-2工具越多越强">#</a></h4>
<p>错。工具太多会拉低决策稳定性。先做 3-5 个高价值工具，跑顺再扩。</p>
<h4 id="误区-3只看首轮效果不看长任务稳定性">误区 3：只看首轮效果，不看长任务稳定性<a hidden class="anchor" aria-hidden="true" href="#误区-3只看首轮效果不看长任务稳定性">#</a></h4>
<p>你应该盯的是：</p>
<ul>
<li>多步任务完成率</li>
<li>工具调用失败率</li>
<li>平均调用 hops</li>
<li>人工接管率</li>
</ul>
<h3 id="六最小落地清单可直接照着做">六、最小落地清单（可直接照着做）<a hidden class="anchor" aria-hidden="true" href="#六最小落地清单可直接照着做">#</a></h3>
<ol>
<li>先选一个单场景（例如“发布故障定位”）。</li>
<li>只接 3 个 MCP 工具：日志检索、配置读取、执行建议。</li>
<li>Responses API 做任务拆解和工具路由。</li>
<li>加审批闸门（高风险动作必须人确认）。</li>
<li>跑 1 周日志，按失败路径迭代。</li>
</ol>
<p>这套做完，你的 Agent 才算从“能演示”升级到“能上线”。</p>
<h3 id="总结">总结<a hidden class="anchor" aria-hidden="true" href="#总结">#</a></h3>
<p><strong>Responses API 负责“脑子”，MCP 负责“手脚”，工作流负责“规矩”。</strong></p>
<p>三者拆开你会很痛苦，组合起来才是生产可用的 Agent 架构。</p>
<p>如果你正在从 function calling 迁移，建议按“单场景 MVP → 指标化 → 扩工具”这条路径走，别一上来就全家桶。</p>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://www.mfun.ink/tags/openai-responses-api/">OpenAI Responses API</a></li>
      <li><a href="https://www.mfun.ink/tags/mcp/">MCP</a></li>
      <li><a href="https://www.mfun.ink/tags/agent/">Agent</a></li>
      <li><a href="https://www.mfun.ink/tags/%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8/">函数调用</a></li>
      <li><a href="https://www.mfun.ink/tags/ai-%E5%B7%A5%E4%BD%9C%E6%B5%81/">AI 工作流</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://www.mfun.ink/2026/02/14/go-memory-leak-pprof-flamegraph/">
    <span class="title">« </span>
    <br>
    <span>Go 服务内存泄漏定位实战：pprof &#43; FlameGraph 一次找准</span>
  </a>
  <a class="next" href="https://www.mfun.ink/2026/02/11/wsl2-docker-network-troubleshooting/">
    <span class="title"> »</span>
    <br>
    <span>WSL2 &#43; Docker 网络异常排查：DNS 超时、拉镜像失败到恢复可用</span>
  </a>
</nav>


<ul class="share-buttons">
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share OpenAI Responses API &#43; MCP 实战：从函数调用到 Agent 工作流 on x"
            href="https://x.com/intent/tweet/?text=OpenAI%20Responses%20API%20%2b%20MCP%20%e5%ae%9e%e6%88%98%ef%bc%9a%e4%bb%8e%e5%87%bd%e6%95%b0%e8%b0%83%e7%94%a8%e5%88%b0%20Agent%20%e5%b7%a5%e4%bd%9c%e6%b5%81&amp;url=https%3a%2f%2fwww.mfun.ink%2f2026%2f02%2f11%2fopenai-responses-api-mcp-agent-workflow%2f&amp;hashtags=OpenAIResponsesAPI%2cMCP%2cAgent%2c%e5%87%bd%e6%95%b0%e8%b0%83%e7%94%a8%2cAI%e5%b7%a5%e4%bd%9c%e6%b5%81">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M512 62.554 L 512 449.446 C 512 483.97 483.97 512 449.446 512 L 62.554 512 C 28.03 512 0 483.97 0 449.446 L 0 62.554 C 0 28.03 28.029 0 62.554 0 L 449.446 0 C 483.971 0 512 28.03 512 62.554 Z M 269.951 190.75 L 182.567 75.216 L 56 75.216 L 207.216 272.95 L 63.9 436.783 L 125.266 436.783 L 235.9 310.383 L 332.567 436.783 L 456 436.783 L 298.367 228.367 L 432.367 75.216 L 371.033 75.216 Z M 127.633 110 L 164.101 110 L 383.481 400.065 L 349.5 400.065 Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share OpenAI Responses API &#43; MCP 实战：从函数调用到 Agent 工作流 on linkedin"
            href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fwww.mfun.ink%2f2026%2f02%2f11%2fopenai-responses-api-mcp-agent-workflow%2f&amp;title=OpenAI%20Responses%20API%20%2b%20MCP%20%e5%ae%9e%e6%88%98%ef%bc%9a%e4%bb%8e%e5%87%bd%e6%95%b0%e8%b0%83%e7%94%a8%e5%88%b0%20Agent%20%e5%b7%a5%e4%bd%9c%e6%b5%81&amp;summary=OpenAI%20Responses%20API%20%2b%20MCP%20%e5%ae%9e%e6%88%98%ef%bc%9a%e4%bb%8e%e5%87%bd%e6%95%b0%e8%b0%83%e7%94%a8%e5%88%b0%20Agent%20%e5%b7%a5%e4%bd%9c%e6%b5%81&amp;source=https%3a%2f%2fwww.mfun.ink%2f2026%2f02%2f11%2fopenai-responses-api-mcp-agent-workflow%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share OpenAI Responses API &#43; MCP 实战：从函数调用到 Agent 工作流 on reddit"
            href="https://reddit.com/submit?url=https%3a%2f%2fwww.mfun.ink%2f2026%2f02%2f11%2fopenai-responses-api-mcp-agent-workflow%2f&title=OpenAI%20Responses%20API%20%2b%20MCP%20%e5%ae%9e%e6%88%98%ef%bc%9a%e4%bb%8e%e5%87%bd%e6%95%b0%e8%b0%83%e7%94%a8%e5%88%b0%20Agent%20%e5%b7%a5%e4%bd%9c%e6%b5%81">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share OpenAI Responses API &#43; MCP 实战：从函数调用到 Agent 工作流 on facebook"
            href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.mfun.ink%2f2026%2f02%2f11%2fopenai-responses-api-mcp-agent-workflow%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share OpenAI Responses API &#43; MCP 实战：从函数调用到 Agent 工作流 on whatsapp"
            href="https://api.whatsapp.com/send?text=OpenAI%20Responses%20API%20%2b%20MCP%20%e5%ae%9e%e6%88%98%ef%bc%9a%e4%bb%8e%e5%87%bd%e6%95%b0%e8%b0%83%e7%94%a8%e5%88%b0%20Agent%20%e5%b7%a5%e4%bd%9c%e6%b5%81%20-%20https%3a%2f%2fwww.mfun.ink%2f2026%2f02%2f11%2fopenai-responses-api-mcp-agent-workflow%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share OpenAI Responses API &#43; MCP 实战：从函数调用到 Agent 工作流 on telegram"
            href="https://telegram.me/share/url?text=OpenAI%20Responses%20API%20%2b%20MCP%20%e5%ae%9e%e6%88%98%ef%bc%9a%e4%bb%8e%e5%87%bd%e6%95%b0%e8%b0%83%e7%94%a8%e5%88%b0%20Agent%20%e5%b7%a5%e4%bd%9c%e6%b5%81&amp;url=https%3a%2f%2fwww.mfun.ink%2f2026%2f02%2f11%2fopenai-responses-api-mcp-agent-workflow%2f">
            <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
                <path
                    d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share OpenAI Responses API &#43; MCP 实战：从函数调用到 Agent 工作流 on ycombinator"
            href="https://news.ycombinator.com/submitlink?t=OpenAI%20Responses%20API%20%2b%20MCP%20%e5%ae%9e%e6%88%98%ef%bc%9a%e4%bb%8e%e5%87%bd%e6%95%b0%e8%b0%83%e7%94%a8%e5%88%b0%20Agent%20%e5%b7%a5%e4%bd%9c%e6%b5%81&u=https%3a%2f%2fwww.mfun.ink%2f2026%2f02%2f11%2fopenai-responses-api-mcp-agent-workflow%2f">
            <svg version="1.1" xml:space="preserve" width="30px" height="30px" viewBox="0 0 512 512" fill="currentColor"
                xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape">
                <path
                    d="M449.446 0C483.971 0 512 28.03 512 62.554L512 449.446C512 483.97 483.97 512 449.446 512L62.554 512C28.03 512 0 483.97 0 449.446L0 62.554C0 28.03 28.029 0 62.554 0L449.446 0ZM183.8767 87.9921H121.8427L230.6673 292.4508V424.0079H281.3328V292.4508L390.1575 87.9921H328.1233L256 238.2489z" />
            </svg>
        </a>
    </li>
</ul>

  </footer>

  
  <div class="ad-in-article ad-bottom" style="margin: 20px 0; text-align:center;">
  <ins class="adsbygoogle"
      style="display:block"
      data-ad-client="ca-pub-2789089615690497"
      data-ad-slot="6136665648"
      data-ad-format="auto"
      data-full-width-responsive="true"></ins>
  <script>
      (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2026 <a href="https://www.mfun.ink/">Mengboy 技术笔记</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>




<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
